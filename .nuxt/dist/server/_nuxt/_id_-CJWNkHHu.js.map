{"version":3,"file":"_id_-CJWNkHHu.js","sources":["../../../../pages/pushmailing/edit/[id].vue"],"sourcesContent":["<script setup>\nimport { ref, reactive, onMounted } from \"vue\";\nimport { mdiChartTimelineVariant, mdiChevronLeft, mdiFilterMenu, mdiSend } from \"@mdi/js\";\nimport SectionMain from \"@/components/SectionMain.vue\";\nimport CardBox from \"@/components/CardBox.vue\";\nimport SectionTitleLineWithButton from \"@/components/SectionTitleLineWithButton.vue\";\nimport { proxyBaseUrl } from \"~~/configs/fetchBaseUrl\";\nimport { useMainStore } from \"~~/stores/main\";\n\nconst route = useRoute();\n\nconst router = useRouter();\n\nconst mainStore = useMainStore()\n\nconst preSelectedGroups = ref([]);\n\nfunction boolToInt(bool) {\n  return bool === true ? 1 : 0;\n}\n\nfunction removeTfromDateTime(date) {\n  date = date.concat(\":00\");\n  return date.replace('T', ' ')\n}\n\nconst displayMessage = ref(\"Введите текст\");\nconst displayTitle = ref(\"\");\nconst displaySubtitle = ref(\"\");\nconst currentDate = new Date().toISOString();\nconst groupsLoaded = ref(false);\n\nconst form = reactive({\n  title: displayTitle.value,\n  subtitle: displaySubtitle.value,\n  message: displayMessage.value,\n  groups_id: [],\n  to_all: 0,\n  users_id: [],\n  token: mainStore.userToken,\n  date: currentDate,\n  now: 1,\n  date: '',\n  id: 0\n});\n\nconst sendNow = ref(true);\n\nconst dateToSend = ref(\"\");\n\nconst selectedGroups = ref([]);\n\nonMounted(() => {\n  downloadPushmailingById(route.params.id)\n  form.id = route.params.id;\n});\n\nconst downloadPushmailingById = async (id) => {\n    const path = proxyBaseUrl+'show-message'\n    await $fetch(path, {\n            method: 'POST',\n            body: { token: mainStore.userToken, message_id: id}\n        }).then(r => {\n            displayMessage.value = r.data.message.message;\n            displayTitle.value = r.data.message.title;\n            dateToSend.value = r.data.message.date;\n            sendNow.value = r.data.message.date.split('-')[0] == '0000';\n            if(r.data.all[0].to_all != 1){\n              for(let i = 0; i < r.data.groups.length; i++){\n                preSelectedGroups.value.push(r.data.groups[i].id)\n              }\n            }\n            groupsLoaded.value = true            \n        })\n}\n\nwatch(selectedGroups, () => {\n  form.to_all = boolToInt(selectedGroups.value.length === 0)\n  form.groups_id = selectedGroups.value\n});\n\nwatch(form.value, () => {\n  console.log(form.date);\n})\n\nwatch(sendNow, () => {\n  form.now = boolToInt(sendNow.value)\n  if(sendNow.value){\n    form.date = ''\n  }\n})\n\nwatch(dateToSend, () => {\n  form.date = dateToSend.value\n})\n\nwatch(displayTitle, (newValue) => {\n  form.title = newValue;\n});\n\nwatch(displayMessage, (newValue) => {\n  form.message = newValue;\n});\n\nconst submit = async () => {\n  if (form.message.length == 0) {\n    alert(\"Введите текст\");\n    return;\n  }\n  if(form.now == 0 && form.date == ''){\n    alert(\"Выберите дату рассылки или нажмите «Отправить сейчас»\");\n    return;\n  }\n  const path = proxyBaseUrl + \"edit-message\";\n  await $fetch(path, {\n    method: \"POST\",\n    body: form,\n  }).then((r) => {\n    const resp = r.message;\n    if (resp === \"ok\") {\n      router.back();\n    } else {\n      alert(resp);\n    }\n  });\n};\n\n</script>\n\n<template>\n  <div>\n    <NuxtLayout name=\"authenticated\">\n      <SectionMain>\n        <SectionTitleLine\n          :icon=\"mdiChevronLeft\"\n          title=\"Редактировать уведомление\"\n          :back=\"true\"\n          main\n        >\n        </SectionTitleLine>\n\n        <div class=\"grid grid-cols-3 gap-6\">\n          <div class=\"col-span-2\">\n            <CardBox form>\n              <FormField label=\"Группы\" help=\"Выберите группы для рассылки\">\n                <GroupsIdSelector v-if=\"groupsLoaded\" v-model=\"selectedGroups\" :pre-selected-groups=\"preSelectedGroups\" />\n                <div v-else>Загрузка групп...</div>\n              </FormField>\n              <FormField\n                label=\"Заголовок (необязательно)\"\n                help=\"Заголовок уведомления\"\n              >\n                <FormControl name=\"title\" v-model=\"displayTitle\" />\n              </FormField>\n\n              <FormField label=\"Сообщение\" help=\"Введите сообщение\">\n                <FormControl\n                  type=\"textarea\"\n                  name=\"message\"\n                  v-model=\"displayMessage\"\n                />\n              </FormField>\n\n              <div class=\"flex items-center my-8\">\n                <input type=\"checkbox\" class=\"form-checkbox rounded-full text-primary-500 border-primary-500 \n                focus:ring-primary-500 mr-4 p-3\" v-model=\"sendNow\">\n                <span>Отправить сейчас</span>\n              </div>\n\n              <FormField v-if=\"!sendNow\" label=\"Дата и время\" help=\"В эту дату и время начнется рассылка\">  \n                <FormControl type=\"datetime-local\" name=\"date\" v-model=\"dateToSend\" />\n              </FormField>\n\n              <div class=\"flex flex-row justify-center items-center w-full\">\n                <BaseButton\n                  color=\"info\"\n                  label=\"Отправить\"\n                  @click=\"submit()\"\n                  :icon=\"mdiSend\"\n                />\n              </div>\n            </CardBox>\n          </div>\n          <div\n            class=\"w-80 h-160 border-4 border-slate-800 dark:border-slate-500 rounded-3xl flex flex-col items-center justify-center px-2\"\n          >\n            <div\n              class=\"flex flex-col mx-4 rounded-lg dark:bg-slate-400 bg-slate-300 drop-shadow-md w-full\"\n            >\n              <div\n                class=\"flex flex-row justify-between w-full rounded-t-lg px-2 py-1/2 dark:bg-slate-500\"\n              >\n                <div class=\"flex flex-row\">\n                  <BaseIcon :path=\"mdiSend\" />\n                  <span class=\"font-light text-lg ml-2\">Телеос-1</span>\n                </div>\n                <span class=\"font-light text-display\">сейчас</span>\n              </div>\n\n              <div class=\"w-full flex flex-col px-2 py-2\">\n                <span\n                  v-if=\"displayTitle !== ''\"\n                  class=\"font-bold text-display mb-1\"\n                >\n                  {{ displayTitle }}\n                </span>\n                <span\n                  v-if=\"displaySubtitle !== ''\"\n                  class=\"font-medium text-display my-1\"\n                >\n                  {{ displaySubtitle }}\n                </span>\n                <span\n                  class=\"font-light text-display mt-1 text-ellipsis line-clamp-2\"\n                >\n                  {{ displayMessage }}\n                </span>\n              </div>\n            </div>\n          </div>\n        </div>\n      </SectionMain>\n    </NuxtLayout>\n  </div>\n</template>\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AASc,aAAW;AAEzB,UAAM,SAAS,UAAS;AAExB,UAAM,YAAY,aAAc;AAEhC,UAAM,oBAAoB,IAAI,CAAA,CAAE;AAEhC,aAAS,UAAU,MAAM;AACvB,aAAO,SAAS,OAAO,IAAI;AAAA,IAC7B;AAOA,UAAM,iBAAiB,IAAI,eAAe;AAC1C,UAAM,eAAe,IAAI,EAAE;AAC3B,UAAM,kBAAkB,IAAI,EAAE;AAC9B,UAAM,eAAc,oBAAI,QAAO;AAC/B,UAAM,eAAe,IAAI,KAAK;AAE9B,UAAM,OAAO,SAAS;AAAA,MACpB,OAAO,aAAa;AAAA,MACpB,UAAU,gBAAgB;AAAA,MAC1B,SAAS,eAAe;AAAA,MACxB,WAAW,CAAE;AAAA,MACb,QAAQ;AAAA,MACR,UAAU,CAAE;AAAA,MACZ,OAAO,UAAU;AAAA,MACjB,MAAM;AAAA,MACN,KAAK;AAAA,MACL,MAAM;AAAA,MACN,IAAI;AAAA,IACN,CAAC;AAED,UAAM,UAAU,IAAI,IAAI;AAExB,UAAM,aAAa,IAAI,EAAE;AAEzB,UAAM,iBAAiB,IAAI,CAAA,CAAE;AA0B7B,UAAM,gBAAgB,MAAM;AAC1B,WAAK,SAAS,UAAU,eAAe,MAAM,WAAW,CAAC;AACzD,WAAK,YAAY,eAAe;AAAA,IAClC,CAAC;AAED,UAAM,KAAK,OAAO,MAAM;AACtB,cAAQ,IAAI,KAAK,IAAI;AAAA,IACvB,CAAC;AAED,UAAM,SAAS,MAAM;AACnB,WAAK,MAAM,UAAU,QAAQ,KAAK;AAClC,UAAG,QAAQ,OAAM;AACf,aAAK,OAAO;AAAA,MACb;AAAA,IACH,CAAC;AAED,UAAM,YAAY,MAAM;AACtB,WAAK,OAAO,WAAW;AAAA,IACzB,CAAC;AAED,UAAM,cAAc,CAAC,aAAa;AAChC,WAAK,QAAQ;AAAA,IACf,CAAC;AAED,UAAM,gBAAgB,CAAC,aAAa;AAClC,WAAK,UAAU;AAAA,IACjB,CAAC;AAED,UAAM,SAAS,YAAY;AACzB,UAAI,KAAK,QAAQ,UAAU,GAAG;AAC5B,cAAM,eAAe;AACrB;AAAA,MACD;AACD,UAAG,KAAK,OAAO,KAAK,KAAK,QAAQ,IAAG;AAClC,cAAM,wDAAwD;AAC9D;AAAA,MACD;AACD,YAAM,OAAO,eAAe;AAC5B,YAAM,OAAO,MAAM;AAAA,QACjB,QAAQ;AAAA,QACR,MAAM;AAAA,MACV,CAAG,EAAE,KAAK,CAAC,MAAM;AACb,cAAM,OAAO,EAAE;AACf,YAAI,SAAS,MAAM;AACjB,iBAAO,KAAI;AAAA,QACjB,OAAW;AACL,gBAAM,IAAI;AAAA,QACX;AAAA,MACL,CAAG;AAAA,IACH;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;"}