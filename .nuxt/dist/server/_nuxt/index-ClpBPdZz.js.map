{"version":3,"file":"index-ClpBPdZz.js","sources":["../../../../pages/pushmailing/index.vue"],"sourcesContent":["<script setup>\r\nimport { ref, reactive, onMounted } from \"vue\";\r\nimport { mdiChartTimelineVariant, mdiFilterMenu, mdiSend } from \"@mdi/js\";\r\nimport SectionMain from \"@/components/SectionMain.vue\";\r\nimport CardBox from \"@/components/CardBox.vue\";\r\nimport SectionTitleLineWithButton from \"@/components/SectionTitleLineWithButton.vue\";\r\nimport { proxyBaseUrl } from \"~~/configs/fetchBaseUrl\";\r\nimport { useMainStore } from \"~~/stores/main\";\r\n\r\nconst route = useRoute();\r\n\r\nconst mainStore = useMainStore()\r\n\r\nconst preSelectedGroups = ref([]);\r\n\r\nonMounted(() => {\r\n  if (route.query.groupid) {\r\n    preSelectedGroups.value.push(route.query.groupid);\r\n  }\r\n});\r\n\r\nfunction boolToInt(bool) {\r\n  return bool === true ? 1 : 0;\r\n}\r\n\r\nfunction removeTfromDateTime(date) {\r\n  date = date.concat(\":00\");\r\n  return date.replace('T', ' ')\r\n}\r\n\r\nconst displayMessage = ref(\"\");\r\nconst displayTitle = ref(\"Телеос-1\");\r\nconst currentDate = new Date().toISOString();\r\n\r\nconst form = reactive({\r\n  title: displayTitle.value,\r\n  message: displayMessage.value,\r\n  groups_id: [],\r\n  to_all: 0,\r\n  users_id: [],\r\n  token: mainStore.userToken,\r\n  date: currentDate,\r\n  now: 1,\r\n  date: ''\r\n});\r\n\r\nconst sendNow = ref(true);\r\n\r\nconst dateToSend = ref(\"\");\r\n\r\nconst selectedGroups = ref([]);\r\n\r\nwatch(selectedGroups, () => {\r\n  form.to_all = boolToInt(selectedGroups.value.length === 0)\r\n  form.groups_id = selectedGroups.value\r\n});\r\n\r\nwatch(sendNow, () => {\r\n  form.now = boolToInt(sendNow.value)\r\n  if(sendNow.value){\r\n    form.date = ''\r\n  }\r\n})\r\n\r\nwatch(dateToSend, () => {\r\n  form.date = removeTfromDateTime(dateToSend.value)\r\n})\r\n\r\nwatch(displayTitle, (newValue) => {\r\n  form.title = newValue;\r\n});\r\n\r\nwatch(displayMessage, (newValue) => {\r\n  form.message = newValue;\r\n});\r\n\r\nconst submit = async () => {\r\n  if (form.message.length == 0) {\r\n    alert(\"Введите текст\");\r\n    return;\r\n  }\r\n  if(form.title.length == 0){\r\n    alert(\"Введите заголовок\");\r\n    return;\r\n  }\r\n  if(form.now == 0 && form.date == ''){\r\n    alert(\"Выберите дату рассылки или нажмите «Отправить сейчас»\");\r\n    return;\r\n  }\r\n  if(selectedGroups.value.length == 0){\r\n    form.to_all = 1;\r\n    form.groups_id = [];\r\n  }\r\n  const path = proxyBaseUrl + \"create-message\";\r\n  await $fetch(path, {\r\n    method: \"POST\",\r\n    body: form,\r\n  }).then((r) => {\r\n    const resp = r.message;\r\n    if (resp === \"ok\") {\r\n      alert(\"Уведомление отправлено!\");\r\n      form.message = \"\";\r\n      form.title = \"\";\r\n      form.subtitle = \"\";\r\n      form.groups_id = [];\r\n      form.users_id = [];\r\n      form.to_all = 0;\r\n      form.date = '';\r\n      form.now = 1;\r\n    } else {\r\n      alert(resp);\r\n    }\r\n  });\r\n};\r\n\r\n</script>\r\n\r\n<template>\r\n  <div>\r\n    <NuxtLayout name=\"authenticated\">\r\n      <SectionMain>\r\n        <SectionTitleLineWithButton\r\n          :icon=\"mdiChartTimelineVariant\"\r\n          title=\"Рассылка PUSH-уведомлений\"\r\n          main\r\n        >\r\n        <BaseButton\r\n            color=\"success\"\r\n            label=\"План рассылок\"\r\n            to=\"/pushmailing/planned\"\r\n          />   \r\n        </SectionTitleLineWithButton>\r\n        <div class=\"grid grid-cols-3 gap-6\">\r\n          <div class=\"col-span-2\">\r\n            <CardBox form>\r\n              <FormField label=\"Группы\" help=\"Выберите группы для рассылки\">\r\n                <GroupsIdSelector v-model=\"selectedGroups\" :pre-selected-groups=\"preSelectedGroups\" />\r\n              </FormField>\r\n              <FormField\r\n                label=\"Заголовок\"\r\n                help=\"Заголовок уведомления\"\r\n              >\r\n                <FormControl name=\"title\" v-model=\"displayTitle\" />\r\n              </FormField>\r\n\r\n              <!-- <FormField\r\n                label=\"Подзаголовок (необязательно)\"\r\n                help=\"Подзаголовок уведомления\"\r\n              >\r\n                <FormControl name=\"subtitle\" v-model=\"displaySubtitle\" />\r\n              </FormField> -->\r\n\r\n              <FormField label=\"Сообщение\" help=\"Введите сообщение\">\r\n                <FormControl\r\n                  type=\"textarea\"\r\n                  name=\"message\"\r\n                  v-model=\"displayMessage\"\r\n                />\r\n              </FormField>\r\n\r\n              <div class=\"flex items-center my-8\">\r\n                <input type=\"checkbox\" class=\"form-checkbox rounded-full text-primary-500 border-primary-500 \r\n                focus:ring-primary-500 mr-4 p-3\" v-model=\"sendNow\">\r\n                <span>Отправить сейчас</span>\r\n              </div>\r\n\r\n              <FormField v-if=\"!sendNow\" label=\"Дата и время\" help=\"В эту дату и время начнется рассылка\">  \r\n                <FormControl type=\"datetime-local\" name=\"date\" v-model=\"dateToSend\" />\r\n              </FormField>\r\n\r\n              <div class=\"flex flex-row justify-center items-center w-full\">\r\n                <BaseButton\r\n                  color=\"info\"\r\n                  label=\"Отправить\"\r\n                  @click=\"submit()\"\r\n                  :icon=\"mdiSend\"\r\n                />\r\n              </div>\r\n            </CardBox>\r\n          </div>\r\n          <div\r\n            class=\"w-80 h-160 border-4 border-slate-800 dark:border-slate-500 rounded-3xl flex flex-col items-center justify-center px-2\"\r\n          >\r\n            <div\r\n              class=\"flex flex-col mx-4 rounded-lg dark:bg-slate-400 bg-slate-300 drop-shadow-md w-full\"\r\n            >\r\n              <div\r\n                class=\"flex flex-row justify-between w-full rounded-t-lg px-2 py-1/2 dark:bg-slate-500\"\r\n              >\r\n                <div class=\"flex flex-row\">\r\n                  <BaseIcon :path=\"mdiSend\" />\r\n                  <span class=\"font-light text-lg ml-2\">Телеос-1</span>\r\n                </div>\r\n                <span class=\"font-light text-display\">сейчас</span>\r\n              </div>\r\n\r\n              <div class=\"w-full flex flex-col px-2 py-2\">\r\n                <span\r\n                  v-if=\"displayTitle !== ''\"\r\n                  class=\"font-bold text-display mb-1\"\r\n                >\r\n                  {{ displayTitle }}\r\n                </span>\r\n                <span\r\n                  v-if=\"displaySubtitle !== ''\"\r\n                  class=\"font-medium text-display my-1\"\r\n                >\r\n                  {{ displaySubtitle }}\r\n                </span>\r\n                <span\r\n                  class=\"font-light text-display mt-1 text-ellipsis line-clamp-2\"\r\n                >\r\n                  {{ displayMessage }}\r\n                </span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </SectionMain>\r\n    </NuxtLayout>\r\n  </div>\r\n</template>\r\n"],"names":[],"mappings":"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"}